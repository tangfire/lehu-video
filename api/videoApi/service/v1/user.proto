syntax = "proto3";

package api.videoApi.service.v1;

option go_package = "lehu-video/api/videoApi/service/v1;v1";
option java_multiple_files = true;
option java_package = "api.videoApi.service.v1";
import "google/api/annotations.proto";
import "api/videoApi/service/v1/base.proto";


// 统一的用户模型（聚合来自core和chat服务的数据）
message User {
	// 基础信息（来自videoCore）
	string id = 1;
	string name = 2;
	string nickname = 3;
	string avatar = 4;
	string background_image = 5;
	string signature = 6;
	int32 gender = 7;

	// 统计信息（来自videoCore）
	int64 follow_count = 8;
	int64 follower_count = 9;
	int64 total_favorited = 10;
	int64 work_count = 11;
	int64 favorite_count = 12;
	string created_at = 13;

	// 社交信息（来自videoChat）
	int32 online_status = 14;
	string last_online_time = 15;

	// 关系信息（API层聚合）
	bool is_following = 16;    // 当前用户是否关注ta
	bool is_follower = 17;     // ta是否关注当前用户
	bool is_friend = 18;       // 是否是好友
	string friend_remark = 19; // 好友备注
	string friend_group = 20;  // 好友分组

	// 隐私字段（仅自己可见）
	string mobile = 21;
	string email = 22;
}

// 用户社交信息（用于查询）
message UserSocialQuery {
	string user_id = 1;
	bool need_online_status = 2;
	bool need_relation = 3;
}

// 批量查询用户信息
message BatchGetUserInfoReq {
	repeated string user_ids = 1;
	bool include_private = 2;  // 是否包含隐私字段
	bool include_relation = 3; // 是否包含关系信息
}

message BatchGetUserInfoResp {
	repeated User users = 1;
}

service UserService {
	// 获取验证码
	rpc GetVerificationCode(GetVerificationCodeReq) returns (GetVerificationCodeResp){
		option (google.api.http) = {
			post:"/v1/user/code"
			body:"*"
		};
	};

	// 注册
	rpc Register(RegisterReq) returns(RegisterResp){
		option(google.api.http) = {
			post:"/v1/user/register"
			body:"*"
		};
	};

	// 登录
	rpc Login(LoginReq) returns(LoginResp){
		option (google.api.http) = {
			post:"/v1/user/login"
			body:"*"
		};
	};

	// 获取用户完整信息（聚合core和chat）
	rpc GetUserInfo(GetUserInfoReq) returns (GetUserInfoResp) {
		option (google.api.http) = {
			get: "/v1/user/info/{user_id}"
		};
	};

	// 批量获取用户信息
	rpc BatchGetUserInfo(BatchGetUserInfoReq) returns (BatchGetUserInfoResp) {
		option (google.api.http) = {
			post: "/v1/users/batch"
			body: "*"
		};
	};

	// 更新用户信息
	rpc UpdateUserInfo(UpdateUserInfoReq) returns (UpdateUserInfoResp) {
		option (google.api.http) = {
			put: "/v1/user/info"
			body: "*"
		};
	};

	// 搜索用户
	rpc SearchUsers(SearchUsersReq) returns (SearchUsersResp) {
		option (google.api.http) = {
			post: "/v1/users/search"
			body:"*"
		};
	};

	// 绑定凭证
	rpc BindUserVoucher(BindUserVoucherReq) returns (BindUserVoucherResp) {
		option (google.api.http) = {
			post: "/v1/user/voucher"
			body: "*"
		};
	};

	// 解绑凭证
	rpc UnbindUserVoucher(UnbindUserVoucherReq) returns (UnbindUserVoucherResp) {
		option (google.api.http) = {
			delete: "/v1/user/voucher"
		};
	};
}

message GetVerificationCodeReq{
	string mobile = 1;
	string email = 2;
}

message GetVerificationCodeResp{
	int64 code_id = 1;
}

message RegisterReq{
	string mobile = 1;
	string email = 2;
	string password = 3;
	int64 code_id = 4;
	string code = 5;
}

message RegisterResp {
	string user_id = 1;
}


message LoginReq {
	string mobile = 1 ;
	string email = 2 ;
	string password = 3 ;
}

message LoginResp {
	string token = 1;
	User user = 2;
}

message GetUserInfoReq {
	string user_id = 1;
}

message GetUserInfoResp {
	User user = 2;
}


message UpdateUserInfoReq {
	string user_id = 1 ;
	string name = 2;
	string avatar = 3;
	string background_image = 4;
	string signature = 5;
	string nickname = 6;
	int32 gender = 7;
}

message UpdateUserInfoResp {
}


enum VoucherType {
	PHONE = 0;
	EMAIL = 1;
}

message BindUserVoucherReq {
	VoucherType voucher_type = 1;
	string voucher = 2;
}

message BindUserVoucherResp {
}

message UnbindUserVoucherReq {
	VoucherType voucher_type = 1;
	string voucher = 2;
}

message UnbindUserVoucherResp {
}

// 搜索用户请求
message SearchUsersReq {
	string keyword = 1;
	PageStatsReq page_stats = 2;
}

message SearchUsersResp {
	repeated User users = 1;
	PageStatsResp page_stats = 2;
}